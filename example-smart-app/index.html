<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <title>Sample SMART on FHIR App</title>

    <link rel='stylesheet' type='text/css' href='./src/css/example-smart-app.css'>
  </head>
  <body>
    <div id='errors'>
    </div>
    <div id="loading" class="spinner">
      <div class="bounce1"></div>
      <div class="bounce2"></div>
      <div class="bounce3"></div>
    </div>
    <div id='holder' >
      <h2>Example-SMART-App</h2>

      <h2>Patient Resource</h2>
      <table>
        <tr>
          <th>First Name:</th>
          <td id='fname'></td>
        </tr>
        <tr>
          <th>Last Name:</th>
          <td id='lname'></td>
        </tr>
        <tr>
          <th>Gender:</th>
          <td id='gender'></td>
        </tr>
        <tr>
          <th>Date of Birth:</th>
          <td id='birthdate'></td>
        </tr>
      </table>
      <h2>Observation Resource</h2>
      <table>
        <!-- <tr>
          <th>Lymph:</th>
          <td id='lymph'></td>
        </tr> -->
        <tr>
          <th>Height:</th>
          <td id='height'></td>
        </tr>
        <tr>
          <th>Systolic Blood Pressure:</th>
          <td id='systolicbp'></td>

        </tr>
        <tr>
          <th>Diastolic Blood Pressure:</th>
          <td id='diastolicbp'></td>
        </tr>
        <tr>
          <th>LDL:</th>
          <td id='ldl'></td>
        </tr>
        <tr>
          <th>HDL:</th>
          <td id='hdl'></td>
        </tr>
      </table>
    </div>

    <!-- Application-level javascript-->
    <script src='./src/js/example-smart-app.js'></script>

    <!-- FHIR Client JS Library -->
    <!-- <script src='./lib/js/fhir-client-v2.5.4.js'></script> -->
    <script src='./lib/js/fhir-client-v2.5.4.js'></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>
      // extractData().then(
      //   //Display Patient Demographics and Observations if extractData was success
      //   function(p) {
      //     drawVisualization(p);
      //   },

      //   //Display 'Failed to call FHIR Service' if extractData failed
      //   function() {
      //     $('#loading').hide();
      //     $('#errors').html('<p> Failed to call FHIR Service </p>');
      //   }
      // );

      function onError() {
          console.log('Loading error', arguments);
          ret.reject();
        }

      function onReady(client) {
        if (client.hasOwnProperty('patient')) {
          var patient = client.patient;
          console.log('patient:');
          console.log(patient)

          var pt = patient.read();

          // var obv = client.patient.api.fetchAll({
          //   type: 'Observation',
          //   query: {
          //     code: {
          //       $or: ['http://loinc.org|8302-2', 'http://loinc.org|8462-4',
          //         'http://loinc.org|8480-6', 'http://loinc.org|2085-9',
          //         'http://loinc.org|2089-1', 'http://loinc.org|55284-4']
          //     }
          //   }
          // });

          var codes = ['http://loinc.org|8302-2', 'http://loinc.org|8462-4'];

          // 'http://loinc.org|55284-4' - Error: Cannot filter "loinc.org|55284-4" resources by patient

          var obv = client.patient.request("Observation/http://loinc.org|8302-2", {
            pageLimit: 0,
            onPage(bundle) {
              comsole.log("Observation onPage");
              console.log(bundle);
            }
          });

          $.when(pt, obv).fail(onError);

          $.when(pt, obv).done(function (patient, obv) {
            console.log("patient done:");
            console.log(patient);
            console.log("obv done:");
            console.log(obv);
          });
        }
        else {
          onError();
        }
      }

      FHIR.oauth2.ready()
          .then(onReady)
          .then(console.log)
          .catch(console.error);
    </script>
  </body>
</html>
